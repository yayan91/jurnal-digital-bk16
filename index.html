<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Digital BK - Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff', 
                            100: '#dbeafe', 
                            500: '#3b82f6', 
                            600: '#2563eb', 
                            700: '#1d4ed8', 
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS TAMPILAN LAYAR (Screen) */
        body { background-color: #f8fafc; color: #334155; }
        .hidden { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loading Spinner Modern */
        .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spin { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: s 0.8s ease-in-out infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* Modal Animation */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; transition: opacity 0.3s; }
        .modal-box { background: white; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); transform: scale(1); animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Tab Navigation Modern */
        .tab-btn { padding: 16px; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; flex: 1; text-align: center; transition: all 0.3s; position: relative; }
        .tab-btn i { transition: transform 0.3s; }
        .tab-btn:hover { color: #2563eb; background: #eff6ff; }
        .tab-btn:hover i { transform: translateY(-2px); }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }

        /* Input Styling */
        input, select, textarea { transition: all 0.2s; border: 1px solid #e2e8f0; background-color: #fff; }
        input:focus, select:focus, textarea:focus { ring: 2px; --tw-ring-color: #bfdbfe; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* --- CSS KHUSUS CETAK PDF (PRINT) - TIDAK DIUBAH AGAR RAPI --- */
        @media print {
            @page { size: 21.5cm 33cm; margin: 1.5cm; }
            body > * { display: none !important; }
            #printArea { 
                display: block !important; 
                position: absolute; 
                top: 0; left: 0; 
                width: 100%; 
                background: white; 
                color: black;
                font-family: 'Times New Roman', serif;
                z-index: 9999;
            }
            .kop { text-align: center; border-bottom: 3px double black; padding-bottom: 10px; margin-bottom: 20px; }
            .k1 { font-size: 14pt; font-weight: bold; text-transform: uppercase; line-height: 1.2; }
            .k2 { font-size: 16pt; font-weight: bold; text-transform: uppercase; margin: 5px 0; line-height: 1.2; }
            .k3 { font-size: 11pt; font-style: italic; }
            .judul-pdf { text-align: center; font-weight: bold; text-decoration: underline; font-size: 14pt; margin-top: 20px; text-transform: uppercase; }
            .info-ta { text-align: center; font-size: 12pt; font-weight: bold; margin-bottom: 20px; }
            .tbl-pdf { width: 100%; border-collapse: collapse; font-size: 12pt; margin-bottom: 30px; }
            .tbl-pdf td { border: 1px solid black; padding: 8px; vertical-align: top; }
            .col-label { width: 30%; font-weight: bold; background-color: #f3f3f3; }
            .ttd-wrap { display: flex; justify-content: space-between; margin-top: 50px; page-break-inside: avoid; }
            .ttd-box { text-align: center; width: 40%; }
            .ttd-nama { font-weight: bold; text-decoration: underline; margin-top: 80px; font-size: 12pt; }
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading" class="loader hidden">
        <div class="spin mb-4"></div>
        <p class="font-bold text-gray-700 animate-pulse">Sedang Memproses...</p>
    </div>

    <div id="modalView" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="bg-gradient-to-r from-brand-900 to-brand-700 text-white px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-book-open"></i> Detail Jurnal</h3>
                <button onclick="closeModal()" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 text-gray-700" id="modalContent"></div>
            <div class="bg-gray-50 px-6 py-4 text-right border-t border-gray-100">
                <button onclick="closeModal()" class="bg-white border border-gray-300 text-gray-700 px-5 py-2 rounded-lg font-medium hover:bg-gray-100 transition shadow-sm">Tutup</button>
            </div>
        </div>
    </div>

    <div id="pageLogin" class="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-slate-100 via-blue-50 to-slate-200">
        <div class="bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-xl w-full max-w-sm border border-white/50 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-600"></div>
            
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl shadow-inner">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-800">JURNAL BK</h2>
                <p class="text-sm text-slate-500 mt-1">Sistem Informasi Bimbingan Konseling</p>
            </div>

            <form onsubmit="doLogin(event)" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 ml-1">USERNAME</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400"><i class="fas fa-user"></i></span>
                        <input id="u" type="text" class="w-full border-gray-200 pl-10 pr-4 py-3 rounded-xl focus:ring-blue-500 shadow-sm" placeholder="NIP / Username" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1.5 ml-1">PASSWORD</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400"><i class="fas fa-lock"></i></span>
                        <input id="p" type="password" class="w-full border-gray-200 pl-10 pr-4 py-3 rounded-xl focus:ring-blue-500 shadow-sm" placeholder="********" required>
                    </div>
                </div>
                <button class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3.5 rounded-xl hover:shadow-lg hover:shadow-blue-500/30 hover:-translate-y-0.5 transition duration-200">
                    MASUK APLIKASI
                </button>
            </form>
            
            <div class="mt-8 text-center text-[10px] text-gray-400">
                &copy; 2026 Jurnal Digital BK - Muhammad Hasratul
            </div>
        </div>
    </div>

    <div id="pageMain" class="hidden min-h-screen pb-20 bg-slate-50">
        
        <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40 border-b border-gray-100">
            <div class="max-w-4xl mx-auto flex justify-between items-center p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i class="fas fa-school"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 leading-tight" id="dSekolah">Loading...</div>
                        <div class="text-xs text-gray-500 mt-0.5">Guru: <span id="dGuru" class="font-bold text-blue-600"></span></div>
                    </div>
                </div>
                <button onclick="logout()" class="text-xs bg-red-50 text-red-600 border border-red-100 px-4 py-2 rounded-full hover:bg-red-600 hover:text-white font-bold transition flex items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Keluar
                </button>
            </div>
            
            <div class="max-w-4xl mx-auto flex border-t border-gray-100 bg-white">
                <div onclick="switchTab('input')" id="tab1" class="tab-btn active">
                    <i class="fas fa-edit mr-2"></i> INPUT JURNAL
                </div>
                <div onclick="switchTab('history')" id="tab2" class="tab-btn">
                    <i class="fas fa-history mr-2"></i> RIWAYAT
                </div>
            </div>
        </header>

        <div class="max-w-4xl mx-auto mt-6 px-4">
            
            <div id="viewInput">
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="font-bold text-xl text-gray-800" id="formTitle">Input Kegiatan</h3>
                            <p class="text-xs text-gray-400 mt-1">Silakan lengkapi form jurnal harian di bawah ini</p>
                        </div>
                        <button onclick="resetForm()" id="btnCancel" class="hidden bg-red-50 text-red-600 px-3 py-1 rounded-lg text-xs font-bold uppercase hover:bg-red-100 transition">Batal Edit</button>
                    </div>

                    <form id="formJurnal" onsubmit="submitData(event)" class="space-y-5">
                        <input type="hidden" name="id" id="inputId">
                        
                        <div class="grid md:grid-cols-2 gap-5">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1.5">TANGGAL KEGIATAN</label>
                                <input type="date" name="tanggal" required class="w-full px-4 py-2.5 rounded-lg border-gray-200 bg-blue-50/50 focus:bg-white">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1.5">JAM KE-</label>
                                    <input type="text" name="jam" placeholder="1-2" class="w-full px-4 py-2.5 rounded-lg border-gray-200">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 block mb-1.5">DURASI</label>
                                    <input type="text" name="waktu" placeholder="40 Menit" class="w-full px-4 py-2.5 rounded-lg border-gray-200">
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1.5">SASARAN LAYANAN</label>
                                <div class="relative">
                                    <i class="fas fa-users absolute left-3 top-3 text-gray-300 text-xs"></i>
                                    <input type="text" name="sasaran" placeholder="Siswa / Guru / Orang Tua" required class="w-full pl-9 pr-4 py-2.5 rounded-lg border-gray-200">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1.5">KELAS / STATUS</label>
                                <input type="text" name="kelas" placeholder="Cth: IX A" class="w-full px-4 py-2.5 rounded-lg border-gray-200">
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1.5">BIDANG BIMBINGAN</label>
                                <select name="bidang" class="w-full px-4 py-2.5 rounded-lg border-gray-200 bg-white">
                                    <option>Pribadi</option>
                                    <option>Sosial</option>
                                    <option>Belajar</option>
                                    <option>Karir</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1.5">JENIS LAYANAN</label>
                                <input type="text" name="jenis" list="ls" class="w-full px-4 py-2.5 rounded-lg border-gray-200" placeholder="Pilih atau Ketik...">
                                <datalist id="ls"><option value="Konseling Individu"><option value="Bimbingan Kelompok"><option value="Bimbingan Klasikal"><option value="Konsultasi"><option value="Alih Tangan Kasus"></datalist>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 block mb-1.5">TOPIK / MASALAH</label>
                            <input type="text" name="topik" class="w-full px-4 py-2.5 rounded-lg border-gray-200 font-medium" placeholder="Inti permasalahan atau topik layanan...">
                        </div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1.5">TUJUAN LAYANAN</label>
                                <textarea name="tujuan" rows="2" class="w-full px-4 py-2.5 rounded-lg border-gray-200"></textarea>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 block mb-1.5">MEDIA / ALAT</label>
                                <input type="text" name="media" class="w-full px-4 py-2.5 rounded-lg border-gray-200">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 block mb-1.5">RINGKASAN PROSES</label>
                            <textarea name="ringkasan" rows="3" class="w-full px-4 py-2.5 rounded-lg border-gray-200"></textarea>
                        </div>

                        <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-sm text-slate-600 mb-3 flex items-center gap-2"><i class="fas fa-clipboard-check"></i> Evaluasi & Tindak Lanjut</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div><label class="text-[10px] font-bold text-gray-400 block mb-1">EVALUASI</label><textarea name="evaluasi" rows="2" class="w-full p-2 text-sm rounded border border-gray-200 focus:border-blue-300"></textarea></div>
                                <div><label class="text-[10px] font-bold text-gray-400 block mb-1">TINDAK LANJUT</label><textarea name="tindaklanjut" rows="2" class="w-full p-2 text-sm rounded border border-gray-200 focus:border-blue-300"></textarea></div>
                                <div><label class="text-[10px] font-bold text-gray-400 block mb-1">CATATAN KHUSUS</label><textarea name="catatan" rows="2" class="w-full p-2 text-sm rounded border border-gray-200 focus:border-blue-300"></textarea></div>
                            </div>
                        </div>

                        <button id="btnSimpan" class="w-full bg-brand-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-500/30 hover:bg-brand-700 hover:-translate-y-1 transition transform duration-200 flex justify-center items-center gap-2 text-sm md:text-base">
                            <i class="fas fa-save"></i> SIMPAN JURNAL
                        </button>
                    </form>
                </div>
            </div>

            <div id="viewHistory" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-bold text-xl text-gray-800">Riwayat Kegiatan</h3>
                        <p class="text-xs text-gray-500">Daftar jurnal yang telah Anda masukkan</p>
                    </div>
                    <button onclick="loadHistory()" class="bg-white border border-gray-200 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-50 transition">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div id="listContainer" class="space-y-4 pb-20">
                    </div>
            </div>

        </div>
    </div>

    <div id="printArea" class="hidden">
        <div class="kop">
            <div class="k1" id="p_pem"></div>
            <div class="k1" id="p_ins"></div>
            <div class="k2" id="p_sek"></div>
            <div class="k3" id="p_almt"></div>
        </div>

        <div class="judul-pdf" id="p_judul">LAPORAN PELAKSANAAN LAYANAN BIMBINGAN DAN KONSELING</div>
        <div class="info-ta">
            Tahun Pelajaran: <span id="p_ta"></span> | Semester: <span id="p_sem"></span>
        </div>

        <table class="tbl-pdf">
            <tr><td class="col-label">Hari, Tanggal</td><td id="t1"></td></tr>
            <tr><td class="col-label">Jam / Waktu Layanan</td><td><span id="t2"></span> / <span id="t3"></span></td></tr>
            <tr><td class="col-label">Sasaran Layanan</td><td id="t4"></td></tr>
            <tr><td class="col-label">Kelas / Status</td><td id="t5"></td></tr>
            <tr><td class="col-label">Bidang Bimbingan</td><td id="t6"></td></tr>
            <tr><td class="col-label">Jenis Layanan</td><td id="t7"></td></tr>
            <tr><td class="col-label">Topik / Masalah</td><td id="t8"></td></tr>
            <tr><td class="col-label">Tujuan Layanan</td><td id="t9"></td></tr>
            <tr><td class="col-label">Media / Alat</td><td id="t10"></td></tr>
            <tr><td class="col-label">Ringkasan Proses</td><td id="t11" style="min-height: 80px;"></td></tr>
            <tr><td class="col-label">Hasil Evaluasi</td><td id="t12"></td></tr>
            <tr><td class="col-label">Rencana Tindak Lanjut</td><td id="t13"></td></tr>
            <tr><td class="col-label">Catatan Khusus</td><td id="t14"></td></tr>
        </table>

        <div class="ttd-wrap">
            <div class="ttd-box">
                <p>Mengetahui,</p>
                <p>Kepala Sekolah</p>
                <div class="ttd-nama" id="pkep"></div>
                <p>NIP. <span id="pnipkep"></span></p>
            </div>
            <div class="ttd-box">
                <p>Makassar, <span id="ptglttd"></span></p>
                <p>Guru BK</p>
                <div class="ttd-nama" id="pguru"></div>
                <p>NIP. <span id="pnipguru"></span></p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PASTE URL WEB APP APPS SCRIPT DI SINI
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxMbp7LlrCgbwoAIB_xCtrHCTpRI9s2zKT7BhH7E-d2qOnP2O8AzO4vxjl-EsaDMTwGog/exec"; 

        let user=null, conf=null, historyData=[];

        function switchTab(t){
            document.getElementById('viewInput').classList.add('hidden');
            document.getElementById('viewHistory').classList.add('hidden');
            document.getElementById('tab1').classList.remove('active');
            document.getElementById('tab2').classList.remove('active');
            if(t=='input'){
                document.getElementById('viewInput').classList.remove('hidden');
                document.getElementById('tab1').classList.add('active');
            } else {
                document.getElementById('viewHistory').classList.remove('hidden');
                document.getElementById('tab2').classList.add('active');
                loadHistory();
            }
        }

        async function doLogin(e){
            e.preventDefault(); loading(true);
            try {
                let u=document.getElementById('u').value, p=document.getElementById('p').value;
                let r=await fetch(`${API_URL}?action=login&u=${u}&p=${p}`).then(x=>x.json());
                if(r.status=='sukses'){
                    user=r;
                    conf=await fetch(`${API_URL}?action=getConfig`).then(x=>x.json());
                    document.getElementById('pageLogin').classList.add('hidden');
                    document.getElementById('pageMain').classList.remove('hidden');
                    document.getElementById('dSekolah').innerText=conf.sekolah;
                    document.getElementById('dGuru').innerText=user.nama;
                    switchTab('input');
                } else alert(r.message);
            } catch(e){alert("Gagal Koneksi ke Server");}
            loading(false);
        }

        async function submitData(e){
            e.preventDefault();
            // Ganti confirm standar dengan yang lebih halus (optional), tapi ini tetap pakai native
            if(!confirm("Simpan Data?")) return;
            loading(true);
            
            let fd = new FormData(document.getElementById('formJurnal'));
            let d = Object.fromEntries(fd.entries());
            d.action="simpan"; d.namaGuru=user.nama; d.nipGuru=user.nip; 
            d.alamatGuru=user.alamat; d.ta=conf.ta; d.semester=conf.semester;

            try {
                await fetch(API_URL, {method:'POST', body:JSON.stringify(d)});
                alert("Berhasil Disimpan!");
                resetForm();
                switchTab('history');
            } catch(x){alert("Gagal Simpan");}
            loading(false);
        }

        async function loadHistory(){
            try {
                let r=await fetch(`${API_URL}?action=getHistory&nip=${user.nip}`).then(x=>x.json());
                historyData=r.data;
                let h="";
                if(historyData.length==0) h=`
                    <div class="text-center p-10 bg-white border border-dashed border-gray-300 rounded-xl">
                        <div class="text-gray-300 text-4xl mb-3"><i class="fas fa-folder-open"></i></div>
                        <div class="text-gray-500 font-medium">Belum ada data jurnal.</div>
                        <div class="text-xs text-gray-400">Silakan input kegiatan baru.</div>
                    </div>`;
                
                historyData.forEach((d,i)=>{
                    // Styling Modern untuk Card List
                    h+=`
                    <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md hover:-translate-y-1 transition duration-200 group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                        <div class="flex justify-between items-start mb-2 pl-3">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg leading-snug">${d.topik}</h4>
                                <div class="text-xs text-blue-600 font-bold mt-1 bg-blue-50 inline-block px-2 py-0.5 rounded uppercase tracking-wide">${d.jenis}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-gray-600">${d.tanggal.substring(0,10)}</div>
                                <div class="text-xs text-gray-400">${d.jam}</div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-500 mb-4 pl-3 flex items-center gap-2">
                             <i class="fas fa-user-tag text-xs"></i> ${d.sasaran} <span class="text-gray-300">|</span> <span class="font-bold text-gray-600">${d.kelas}</span>
                        </div>
                        <div class="flex gap-2 border-t pt-3 pl-3">
                            <button onclick="viewItem(${i})" class="flex-1 bg-gray-50 text-gray-600 py-2 rounded-lg text-xs font-bold hover:bg-gray-100 hover:text-blue-600 transition flex items-center justify-center gap-1"><i class="fas fa-eye"></i> DETAIL</button>
                            <button onclick="editItem(${i})" class="flex-1 bg-yellow-50 text-yellow-600 py-2 rounded-lg text-xs font-bold hover:bg-yellow-100 transition flex items-center justify-center gap-1"><i class="fas fa-edit"></i> EDIT</button>
                            <button onclick="printItem(${i})" class="flex-1 bg-green-50 text-green-600 py-2 rounded-lg text-xs font-bold hover:bg-green-100 transition flex items-center justify-center gap-1"><i class="fas fa-print"></i> PDF</button>
                            <button onclick="deleteItem('${d.id}')" class="flex-1 bg-red-50 text-red-500 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition flex items-center justify-center gap-1"><i class="fas fa-trash"></i> HAPUS</button>
                        </div>
                    </div>`;
                });
                document.getElementById('listContainer').innerHTML=h;
            } catch(e){}
        }

        function viewItem(i){
            let d=historyData[i];
            // Tampilan Modal Detail yang lebih rapi
            let html=`
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 bg-blue-50/50 p-4 rounded-lg border border-blue-100">
                        <div><div class="text-xs text-gray-400 font-bold uppercase">Tanggal</div><div class="font-bold text-gray-800">${d.tanggal.substring(0,10)}</div></div>
                        <div><div class="text-xs text-gray-400 font-bold uppercase">Waktu</div><div class="font-bold text-gray-800">${d.jam} (${d.waktu})</div></div>
                        <div><div class="text-xs text-gray-400 font-bold uppercase">Sasaran</div><div class="font-bold text-gray-800">${d.sasaran} (${d.kelas})</div></div>
                        <div><div class="text-xs text-gray-400 font-bold uppercase">Layanan</div><div class="font-bold text-gray-800">${d.jenis}</div></div>
                    </div>
                    
                    <div>
                        <div class="text-xs text-gray-400 font-bold uppercase mb-1">Topik / Masalah</div>
                        <div class="bg-gray-50 p-3 rounded border border-gray-100 text-gray-700 text-sm font-medium">${d.topik}</div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Tujuan</div>
                            <div class="bg-gray-50 p-3 rounded border border-gray-100 text-gray-600 text-sm h-full">${d.tujuan}</div>
                        </div>
                         <div>
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Media</div>
                            <div class="bg-gray-50 p-3 rounded border border-gray-100 text-gray-600 text-sm h-full">${d.media}</div>
                        </div>
                    </div>

                    <div>
                        <div class="text-xs text-gray-400 font-bold uppercase mb-1">Ringkasan Proses</div>
                        <div class="bg-gray-50 p-3 rounded border border-gray-100 text-gray-600 text-sm leading-relaxed">${d.ringkasan}</div>
                    </div>

                     <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Evaluasi</div>
                            <div class="bg-yellow-50 p-3 rounded border border-yellow-100 text-gray-700 text-sm">${d.evaluasi}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 font-bold uppercase mb-1">Tindak Lanjut</div>
                            <div class="bg-green-50 p-3 rounded border border-green-100 text-gray-700 text-sm">${d.tindaklanjut}</div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modalContent').innerHTML=html;
            document.getElementById('modalView').classList.remove('hidden');
        }
        function closeModal(){document.getElementById('modalView').classList.add('hidden');}

        function editItem(i){
            let d=historyData[i];
            switchTab('input');
            document.getElementById('inputId').value=d.id;
            let f=document.getElementById('formJurnal');
            f.tanggal.value=d.tanggal.substring(0,10); f.jam.value=d.jam; f.waktu.value=d.waktu;
            f.sasaran.value=d.sasaran; f.kelas.value=d.kelas; f.bidang.value=d.bidang; f.jenis.value=d.jenis;
            f.topik.value=d.topik; f.tujuan.value=d.tujuan; f.media.value=d.media;
            f.ringkasan.value=d.ringkasan; f.evaluasi.value=d.evaluasi;
            f.tindaklanjut.value=d.tindaklanjut; f.catatan.value=d.catatan;
            
            document.getElementById('formTitle').innerHTML="Edit Jurnal <span class='text-sm font-normal text-gray-400 ml-2'>Mode Perubahan</span>";
            document.getElementById('btnSimpan').innerHTML="<i class='fas fa-sync'></i> UPDATE DATA JURNAL";
            document.getElementById('btnSimpan').classList.remove('bg-brand-600', 'hover:bg-brand-700');
            document.getElementById('btnSimpan').classList.add('bg-orange-500', 'hover:bg-orange-600');
            document.getElementById('btnCancel').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function resetForm(){
            document.getElementById('formJurnal').reset();
            document.getElementById('inputId').value="";
            document.getElementById('formTitle').innerText="Input Kegiatan Baru";
            document.getElementById('btnSimpan').innerHTML="<i class='fas fa-save'></i> SIMPAN JURNAL";
            
            // Kembalikan warna tombol asli
            document.getElementById('btnSimpan').classList.remove('bg-orange-500', 'hover:bg-orange-600');
            document.getElementById('btnSimpan').classList.add('bg-brand-600', 'hover:bg-brand-700');
            
            document.getElementById('btnCancel').classList.add('hidden');
        }

        async function deleteItem(id){
            if(!confirm("Yakin hapus permanen? Data yang dihapus tidak bisa dikembalikan.")) return;
            loading(true);
            try {
                await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'hapus',id:id})});
                alert("Data Berhasil Dihapus"); loadHistory();
            } catch(e){alert("Gagal Hapus");}
            loading(false);
        }

        // --- FUNGSI CETAK PDF (TIDAK DIUBAH LOGIKANYA) ---
        function printItem(i){
            let d=historyData[i];
            
            // 1. Mapping Header
            document.getElementById('p_pem').innerText=conf.pem;
            document.getElementById('p_ins').innerText=conf.instansi;
            document.getElementById('p_sek').innerText=conf.sekolah;
            document.getElementById('p_almt').innerText=conf.alamat;
            document.getElementById('p_judul').innerText=conf.judul || "LAPORAN LAYANAN";
            
            // 2. Mapping Data TA & Sem
            document.getElementById('p_ta').innerText=conf.ta;
            document.getElementById('p_sem').innerText=conf.semester;

            // 3. Mapping Isi Tabel
            document.getElementById('t1').innerText=d.tanggal.substring(0,10);
            document.getElementById('t2').innerText=d.jam; document.getElementById('t3').innerText=d.waktu;
            document.getElementById('t4').innerText=d.sasaran; document.getElementById('t5').innerText=d.kelas;
            document.getElementById('t6').innerText=d.bidang; document.getElementById('t7').innerText=d.jenis;
            document.getElementById('t8').innerText=d.topik; document.getElementById('t9').innerText=d.tujuan;
            document.getElementById('t10').innerText=d.media; document.getElementById('t11').innerText=d.ringkasan;
            document.getElementById('t12').innerText=d.evaluasi; document.getElementById('t13').innerText=d.tindaklanjut;
            document.getElementById('t14').innerText=d.catatan;

            // 4. Mapping TTD
            document.getElementById('pkep').innerText=conf.kepsek; document.getElementById('pnipkep').innerText=conf.nip_kepsek;
            document.getElementById('pguru').innerText=user.nama; document.getElementById('pnipguru').innerText=user.nip;
            document.getElementById('ptglttd').innerText=d.tanggal.substring(0,10);

            // 5. Eksekusi Print
            window.print();
        }

        function logout(){location.reload();}
        function loading(x){document.getElementById('loading').classList.toggle('hidden',!x);}
    </script>
</body>
</html>
