<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Digital BK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none !important; }
        
        /* Loading Spinner */
        .loader { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .spin { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: transparent; border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* Modal Popup */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: white; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Tabs */
        .tab-btn { padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #64748b; border-bottom: 4px solid transparent; flex: 1; transition: all 0.2s; }
        .tab-btn.active { color: #1e40af; border-bottom-color: #1e40af; background: #dbeafe; }
        .tab-btn:hover { background: #eff6ff; }

        /* --- CSS KHUSUS CETAK PDF (FOLIO) --- */
        @media print {
            @page { size: 21.5cm 33cm; margin: 1.5cm; } /* Ukuran Folio */
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; color: black; font-family: 'Times New Roman', serif; background: white; }
            
            /* Kop Surat */
            .kop { text-align: center; border-bottom: 3px double black; padding-bottom: 10px; margin-bottom: 25px; }
            .k1 { font-size: 12pt; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
            .k2 { font-size: 14pt; font-weight: bold; text-transform: uppercase; margin: 2px 0; }
            .k3 { font-size: 10pt; font-style: italic; }

            /* Judul & Isi */
            .judul-lap { text-align: center; font-weight: bold; text-decoration: underline; font-size: 12pt; margin-bottom: 20px; text-transform: uppercase; }
            
            /* Tabel Profesional */
            .tbl-print { width: 100%; border-collapse: collapse; font-size: 11pt; }
            .tbl-print td { border: 1px solid black; padding: 6px 8px; vertical-align: top; }
            .label-cell { font-weight: bold; width: 28%; background-color: #f3f3f3; }
            
            /* Tanda Tangan */
            .ttd-wrapper { display: flex; justify-content: space-between; margin-top: 50px; page-break-inside: avoid; }
            .ttd-col { text-align: center; width: 40%; }
            .ttd-name { font-weight: bold; text-decoration: underline; margin-top: 80px; }
        }
    </style>
</head>
<body>

    <div id="loading" class="loader hidden">
        <div class="spin mb-2"></div>
        <p class="font-semibold tracking-wide">Memproses Data...</p>
    </div>

    <div id="modalView" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="bg-blue-800 text-white p-4 sticky top-0 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-file-alt mr-2"></i> Detail Jurnal</h3>
                <button onclick="closeModal()" class="text-white hover:text-red-300 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div id="modalContent"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 text-right">
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Tutup</button>
            </div>
        </div>
    </div>

    <div id="pageLogin" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-blue-600">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-blue-900">JURNAL BK</h1>
                <p class="text-xs text-gray-500 uppercase tracking-widest">Digital Counseling Log</p>
            </div>
            <form onsubmit="doLogin(event)">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">USERNAME</label>
                    <input id="u" type="text" class="w-full border border-gray-300 p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-600 mb-1">PASSWORD</label>
                    <input id="p" type="password" class="w-full border border-gray-300 p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition transform active:scale-95">MASUK APLIKASI</button>
            </form>
        </div>
    </div>

    <div id="pageMain" class="hidden min-h-screen pb-20">
        
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-4xl mx-auto flex justify-between items-center p-4">
                <div>
                    <div class="font-bold text-lg text-blue-900 leading-tight" id="dSekolah">Loading...</div>
                    <div class="text-xs text-gray-500 mt-1">Login: <span id="dGuru" class="font-bold text-black"></span></div>
                </div>
                <button onclick="logout()" class="text-xs text-red-500 font-bold border border-red-200 px-3 py-1 rounded hover:bg-red-50">LOGOUT</button>
            </div>
            <div class="max-w-4xl mx-auto flex bg-white border-t border-gray-200">
                <div onclick="switchTab('input')" id="tab1" class="tab-btn active"><i class="fas fa-edit mr-2"></i> INPUT JURNAL</div>
                <div onclick="switchTab('history')" id="tab2" class="tab-btn"><i class="fas fa-history mr-2"></i> RIWAYAT</div>
            </div>
        </header>

        <div class="max-w-4xl mx-auto mt-6 px-4">
            
            <div id="viewInput">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-5 border-b pb-3">
                        <h3 class="font-bold text-lg text-gray-800" id="formTitle">Isi Kegiatan Baru</h3>
                        <button onclick="resetForm()" id="btnCancel" class="hidden text-red-500 text-xs font-bold uppercase tracking-wide hover:underline">Batal Edit</button>
                    </div>

                    <form id="formJurnal" onsubmit="submitData(event)" class="space-y-4">
                        <input type="hidden" name="id" id="inputId">
                        
                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">TANGGAL KEGIATAN</label><input type="date" name="tanggal" required class="w-full border p-2 rounded bg-blue-50 focus:border-blue-500"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">JAM (KE-)</label><input type="text" name="jam" placeholder="1-2" class="w-full border p-2 rounded"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">DURASI</label><input type="text" name="waktu" placeholder="40 Menit" class="w-full border p-2 rounded"></div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">SASARAN LAYANAN</label><input type="text" name="sasaran" placeholder="Siswa / Guru / Ortu" required class="w-full border p-2 rounded"></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">KELAS / STATUS</label><input type="text" name="kelas" placeholder="Cth: IX A" class="w-full border p-2 rounded"></div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">BIDANG BIMBINGAN</label>
                                <select name="bidang" class="w-full border p-2 rounded bg-white">
                                    <option>Pribadi</option><option>Sosial</option><option>Belajar</option><option>Karir</option>
                                </select>
                            </div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">JENIS LAYANAN</label><input type="text" name="jenis" list="ls" class="w-full border p-2 rounded" placeholder="Ketik/Pilih..."><datalist id="ls"><option value="Konseling Individu"><option value="Bimbingan Kelompok"><option value="Bimbingan Klasikal"><option value="Konsultasi"></datalist></div>
                        </div>

                        <div><label class="text-xs font-bold text-gray-500 block mb-1">TOPIK / MASALAH</label><input type="text" name="topik" class="w-full border p-2 rounded"></div>
                        
                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">TUJUAN LAYANAN</label><textarea name="tujuan" rows="2" class="w-full border p-2 rounded"></textarea></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">MEDIA / ALAT</label><input type="text" name="media" class="w-full border p-2 rounded"></div>
                        </div>
                        
                        <div><label class="text-xs font-bold text-gray-500 block mb-1">RINGKASAN PROSES</label><textarea name="ringkasan" rows="3" class="w-full border p-2 rounded"></textarea></div>

                        <div class="grid md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded border border-gray-200">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">HASIL EVALUASI</label><textarea name="evaluasi" rows="2" class="w-full border p-2 rounded bg-white"></textarea></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">TINDAK LANJUT</label><textarea name="tindaklanjut" rows="2" class="w-full border p-2 rounded bg-white"></textarea></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">CATATAN KHUSUS</label><textarea name="catatan" rows="2" class="w-full border p-2 rounded bg-white"></textarea></div>
                        </div>

                        <button id="btnSimpan" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition flex justify-center items-center gap-2">
                            <i class="fas fa-save"></i> SIMPAN JURNAL
                        </button>
                    </form>
                </div>
            </div>

            <div id="viewHistory" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">Daftar Riwayat</h3>
                    <button onclick="loadHistory()" class="text-blue-600 hover:underline text-sm"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                </div>
                <div id="listContainer" class="space-y-4 pb-20">
                    </div>
            </div>

        </div>
    </div>

    <div id="printArea" class="hidden">
        <div class="kop">
            <div class="k1" id="p_pem">PEMERINTAH KOTA...</div>
            <div class="k1" id="p_ins">DINAS PENDIDIKAN</div>
            <div class="k2" id="p_sek">NAMA SEKOLAH</div>
            <div class="k3" id="p_almt">Alamat Sekolah...</div>
        </div>

        <div class="judul-lap" id="p_judul">LAPORAN PELAKSANAAN LAYANAN BIMBINGAN DAN KONSELING</div>
        
        <table class="tbl-print">
            <tr><td class="label-cell">Hari, Tanggal</td><td id="t1"></td></tr>
            <tr><td class="label-cell">Jam / Waktu Layanan</td><td><span id="t2"></span> / <span id="t3"></span></td></tr>
            <tr><td class="label-cell">Sasaran Layanan</td><td id="t4"></td></tr>
            <tr><td class="label-cell">Kelas / Status</td><td id="t5"></td></tr>
            <tr><td class="label-cell">Bidang Bimbingan</td><td id="t6"></td></tr>
            <tr><td class="label-cell">Jenis Layanan</td><td id="t7"></td></tr>
            <tr><td class="label-cell">Topik / Masalah</td><td id="t8"></td></tr>
            <tr><td class="label-cell">Tujuan Layanan</td><td id="t9"></td></tr>
            <tr><td class="label-cell">Media / Alat</td><td id="t10"></td></tr>
            <tr><td class="label-cell">Ringkasan Proses</td><td id="t11" style="min-height: 80px;"></td></tr>
            <tr><td class="label-cell">Hasil Evaluasi</td><td id="t12"></td></tr>
            <tr><td class="label-cell">Rencana Tindak Lanjut</td><td id="t13"></td></tr>
            <tr><td class="label-cell">Catatan Khusus</td><td id="t14"></td></tr>
        </table>

        <div class="ttd-wrapper">
            <div class="ttd-col">
                <p>Mengetahui,</p>
                <p>Kepala Sekolah</p>
                <div class="ttd-name" id="pkep">Nama Kepsek</div>
                <p>NIP. <span id="pnipkep"></span></p>
            </div>
            <div class="ttd-col">
                <p>Makassar, <span id="ptglttd"></span></p>
                <p>Guru BK</p>
                <div class="ttd-name" id="pguru">Nama Guru</div>
                <p>NIP. <span id="pnipguru"></span></p>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        // PASTE URL WEB APP GOOGLE APPS SCRIPT DI SINI
        // ===============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxMbp7LlrCgbwoAIB_xCtrHCTpRI9s2zKT7BhH7E-d2qOnP2O8AzO4vxjl-EsaDMTwGog/exec"; 

        let user = null, conf = null, historyData = [];

        // --- SISTEM TAB ---
        function switchTab(t) {
            document.getElementById('viewInput').classList.add('hidden');
            document.getElementById('viewHistory').classList.add('hidden');
            document.getElementById('tab1').classList.remove('active');
            document.getElementById('tab2').classList.remove('active');

            if(t=='input'){
                document.getElementById('viewInput').classList.remove('hidden');
                document.getElementById('tab1').classList.add('active');
            } else {
                document.getElementById('viewHistory').classList.remove('hidden');
                document.getElementById('tab2').classList.add('active');
                loadHistory();
            }
        }

        // --- LOGIN ---
        async function doLogin(e) {
            e.preventDefault(); loading(true);
            let u=document.getElementById('u').value, p=document.getElementById('p').value;
            try {
                let r = await fetch(`${API_URL}?action=login&u=${u}&p=${p}`).then(x=>x.json());
                if(r.status=='sukses'){
                    user = r;
                    conf = await fetch(`${API_URL}?action=getConfig`).then(x=>x.json());
                    document.getElementById('pageLogin').classList.add('hidden');
                    document.getElementById('pageMain').classList.remove('hidden');
                    document.getElementById('dSekolah').innerText = conf.sekolah;
                    document.getElementById('dGuru').innerText = user.nama;
                    switchTab('input');
                } else alert(r.message);
            } catch(e){ alert("Koneksi Gagal/Script URL Salah"); }
            loading(false);
        }

        // --- SIMPAN ---
        async function submitData(e) {
            e.preventDefault();
            if(!confirm("Simpan data ini?")) return;
            loading(true);
            
            let fd = new FormData(document.getElementById('formJurnal'));
            let d = Object.fromEntries(fd.entries());
            d.action="simpan"; d.namaGuru=user.nama; d.nipGuru=user.nip; 
            d.alamatGuru=user.alamat; d.ta=conf.ta; d.semester=conf.semester;

            try {
                // Fetch metode POST aman
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(d) });
                alert("Jurnal Berhasil Disimpan!");
                resetForm();
                switchTab('history');
            } catch(x){ alert("Gagal Simpan: "+x); }
            loading(false);
        }

        // --- LOAD RIWAYAT ---
        async function loadHistory() {
            try {
                let r = await fetch(`${API_URL}?action=getHistory&nip=${user.nip}`).then(x=>x.json());
                historyData = r.data;
                let h="";
                if(historyData.length==0) h=`<div class="text-center p-10 bg-white rounded border border-gray-200 text-gray-400">Belum ada jurnal tersimpan.</div>`;
                
                historyData.forEach((d,i)=>{
                    // Card Riwayat
                    h += `
                    <div class="bg-white p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-blue-900 text-lg">${d.topik || '-'}</div>
                                <div class="text-xs text-gray-500 font-semibold uppercase tracking-wide">
                                    <i class="far fa-calendar mr-1"></i> ${d.tanggal.substring(0,10)}
                                </div>
                            </div>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">${d.jenis}</span>
                        </div>
                        <div class="text-sm text-gray-700 mb-4">
                            Sasaran: <b>${d.sasaran}</b> (${d.kelas})
                        </div>
                        <div class="grid grid-cols-4 gap-2 border-t pt-3">
                            <button onclick="viewItem(${i})" class="bg-gray-100 text-gray-700 py-2 rounded text-xs font-bold hover:bg-gray-200"><i class="fas fa-eye"></i> LIHAT</button>
                            <button onclick="editItem(${i})" class="bg-yellow-50 text-yellow-600 py-2 rounded text-xs font-bold hover:bg-yellow-100"><i class="fas fa-edit"></i> EDIT</button>
                            <button onclick="printItem(${i})" class="bg-green-50 text-green-600 py-2 rounded text-xs font-bold hover:bg-green-100"><i class="fas fa-print"></i> PDF</button>
                            <button onclick="deleteItem('${d.id}')" class="bg-red-50 text-red-600 py-2 rounded text-xs font-bold hover:bg-red-100"><i class="fas fa-trash"></i> HAPUS</button>
                        </div>
                    </div>`;
                });
                document.getElementById('listContainer').innerHTML = h;
            } catch(e){}
        }

        // --- 1. FITUR LIHAT (POPUP) ---
        function viewItem(i) {
            let d = historyData[i];
            let html = `
                <table class="w-full text-sm">
                    <tr><td class="font-bold py-1 w-1/3">Hari/Tanggal</td><td>: ${d.tanggal.substring(0,10)}</td></tr>
                    <tr><td class="font-bold py-1">Jam / Waktu</td><td>: ${d.jam} (${d.waktu})</td></tr>
                    <tr><td class="font-bold py-1">Sasaran</td><td>: ${d.sasaran} - ${d.kelas}</td></tr>
                    <tr><td class="font-bold py-1">Bidang/Jenis</td><td>: ${d.bidang} / ${d.jenis}</td></tr>
                    <tr><td class="font-bold py-1">Topik</td><td>: ${d.topik}</td></tr>
                    <tr><td colspan="2"><hr class="my-2"></td></tr>
                    <tr><td class="font-bold py-1" colspan="2">Tujuan:</td></tr>
                    <tr><td colspan="2" class="pl-2 text-gray-700">${d.tujuan}</td></tr>
                    <tr><td class="font-bold py-1" colspan="2">Ringkasan Proses:</td></tr>
                    <tr><td colspan="2" class="pl-2 text-gray-700">${d.ringkasan}</td></tr>
                    <tr><td class="font-bold py-1" colspan="2">Evaluasi:</td></tr>
                    <tr><td colspan="2" class="pl-2 text-gray-700">${d.evaluasi}</td></tr>
                </table>
            `;
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalView').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modalView').classList.add('hidden'); }

        // --- 2. FITUR CETAK PDF (PROFESIONAL) ---
        function printItem(i) {
            let d = historyData[i];
            
            // Mapping Header Kop Surat
            document.getElementById('p_pem').innerText = conf.pem;
            document.getElementById('p_ins').innerText = conf.instansi;
            document.getElementById('p_sek').innerText = conf.sekolah;
            document.getElementById('p_almt').innerText = conf.alamat;
            document.getElementById('p_judul').innerText = conf.judul || "LAPORAN PELAKSANAAN LAYANAN KONSELING";

            // Mapping Isi Tabel
            document.getElementById('t1').innerText = d.tanggal.substring(0,10);
            document.getElementById('t2').innerText = d.jam; document.getElementById('t3').innerText = d.waktu;
            document.getElementById('t4').innerText = d.sasaran; document.getElementById('t5').innerText = d.kelas;
            document.getElementById('t6').innerText = d.bidang; document.getElementById('t7').innerText = d.jenis;
            document.getElementById('t8').innerText = d.topik; document.getElementById('t9').innerText = d.tujuan;
            document.getElementById('t10').innerText = d.media; document.getElementById('t11').innerText = d.ringkasan;
            document.getElementById('t12').innerText = d.evaluasi; document.getElementById('t13').innerText = d.tindaklanjut;
            document.getElementById('t14').innerText = d.catatan;

            // Mapping Tanda Tangan
            document.getElementById('pkep').innerText = conf.kepsek; 
            document.getElementById('pnipkep').innerText = conf.nip_kepsek;
            document.getElementById('pguru').innerText = user.nama; 
            document.getElementById('pnipguru').innerText = user.nip;
            document.getElementById('ptglttd').innerText = d.tanggal.substring(0,10);

            // Eksekusi Print
            window.print();
        }

        // --- FITUR EDIT ---
        function editItem(i) {
            let d = historyData[i];
            switchTab('input');
            document.getElementById('inputId').value = d.id;
            
            let f = document.getElementById('formJurnal');
            f.tanggal.value=d.tanggal.substring(0,10); f.jam.value=d.jam; f.waktu.value=d.waktu;
            f.sasaran.value=d.sasaran; f.kelas.value=d.kelas; f.bidang.value=d.bidang; f.jenis.value=d.jenis;
            f.topik.value=d.topik; f.tujuan.value=d.tujuan; f.media.value=d.media;
            f.ringkasan.value=d.ringkasan; f.evaluasi.value=d.evaluasi;
            f.tindaklanjut.value=d.tindaklanjut; f.catatan.value=d.catatan;
            
            document.getElementById('formTitle').innerText = "Edit Data Jurnal";
            document.getElementById('btnSimpan').innerHTML = "<i class='fas fa-sync'></i> UPDATE DATA";
            document.getElementById('btnSimpan').classList.replace('bg-blue-600', 'bg-orange-500');
            document.getElementById('btnCancel').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function resetForm() {
            document.getElementById('formJurnal').reset();
            document.getElementById('inputId').value = "";
            document.getElementById('formTitle').innerText = "Isi Kegiatan Baru";
            document.getElementById('btnSimpan').innerHTML = "<i class='fas fa-save'></i> SIMPAN JURNAL";
            document.getElementById('btnSimpan').classList.replace('bg-orange-500', 'bg-blue-600');
            document.getElementById('btnCancel').classList.add('hidden');
        }

        // --- FITUR HAPUS ---
        async function deleteItem(id) {
            if(!confirm("Yakin hapus data ini selamanya?")) return;
            loading(true);
            try {
                await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'hapus', id:id})});
                alert("Data Terhapus");
                loadHistory();
            } catch(e){ alert("Gagal Hapus"); }
            loading(false);
        }

        function logout() { location.reload(); }
        function loading(x) { document.getElementById('loading').classList.toggle('hidden',!x); }
    </script>
</body>
</html>
