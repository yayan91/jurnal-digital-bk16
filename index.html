<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Digital BK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS TAMPILAN LAYAR (Screen) */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none !important; }
        
        /* Loading Spinner */
        .loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .spin { width: 40px; height: 40px; border: 4px solid #fff; border-top-color: transparent; border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        /* Modal Popup */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: white; width: 100%; max-width: 650px; max-height: 90vh; overflow-y: auto; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

        /* Tab Navigation */
        .tab-btn { padding: 15px; cursor: pointer; font-weight: bold; color: #64748b; border-bottom: 3px solid transparent; flex: 1; text-align: center; transition: 0.3s; }
        .tab-btn.active { color: #1e40af; border-bottom-color: #1e40af; background: #dbeafe; }
        .tab-btn:hover { background: #eff6ff; }

        /* --- CSS KHUSUS CETAK PDF (PRINT) --- */
        @media print {
            /* 1. Atur Kertas Folio (F4) */
            @page { size: 21.5cm 33cm; margin: 1.5cm; }
            
            /* 2. Sembunyikan Semua Elemen Aplikasi */
            body > * { display: none !important; }
            
            /* 3. Tampilkan HANYA Area Cetak */
            #printArea { 
                display: block !important; 
                position: absolute; 
                top: 0; left: 0; 
                width: 100%; 
                background: white; 
                color: black;
                font-family: 'Times New Roman', serif;
                z-index: 9999;
            }

            /* Styling Kop Surat */
            .kop { text-align: center; border-bottom: 3px double black; padding-bottom: 10px; margin-bottom: 20px; }
            .k1 { font-size: 14pt; font-weight: bold; text-transform: uppercase; line-height: 1.2; }
            .k2 { font-size: 16pt; font-weight: bold; text-transform: uppercase; margin: 5px 0; line-height: 1.2; }
            .k3 { font-size: 11pt; font-style: italic; }

            /* Judul & Info TA */
            .judul-pdf { text-align: center; font-weight: bold; text-decoration: underline; font-size: 14pt; margin-top: 20px; text-transform: uppercase; }
            .info-ta { text-align: center; font-size: 12pt; font-weight: bold; margin-bottom: 20px; }

            /* Tabel Laporan */
            .tbl-pdf { width: 100%; border-collapse: collapse; font-size: 12pt; margin-bottom: 30px; }
            .tbl-pdf td { border: 1px solid black; padding: 8px; vertical-align: top; }
            .col-label { width: 30%; font-weight: bold; background-color: #f3f3f3; }

            /* Tanda Tangan */
            .ttd-wrap { display: flex; justify-content: space-between; margin-top: 50px; page-break-inside: avoid; }
            .ttd-box { text-align: center; width: 40%; }
            .ttd-nama { font-weight: bold; text-decoration: underline; margin-top: 80px; font-size: 12pt; }
        }
    </style>
</head>
<body>

    <div id="loading" class="loader hidden">
        <div class="spin mb-2"></div>
        <p>Memproses...</p>
    </div>

    <div id="modalView" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="bg-blue-900 text-white p-4 flex justify-between items-center sticky top-0">
                <h3 class="font-bold text-lg"><i class="fas fa-file-alt mr-2"></i> Detail Jurnal</h3>
                <button onclick="closeModal()" class="text-white hover:text-red-400 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6" id="modalContent"></div>
            <div class="bg-gray-100 p-3 text-right">
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Tutup</button>
            </div>
        </div>
    </div>

    <div id="pageLogin" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm border-t-4 border-blue-600">
            <h2 class="text-2xl font-bold text-center text-blue-900 mb-1">JURNAL BK</h2>
            <p class="text-center text-xs text-gray-500 mb-6 uppercase tracking-wider">Aplikasi Bimbingan Konseling</p>
            <form onsubmit="doLogin(event)">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">USERNAME</label>
                    <input id="u" type="text" class="w-full border p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-600 mb-1">PASSWORD</label>
                    <input id="p" type="password" class="w-full border p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <button class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition">MASUK</button>
            </form>
        </div>
    </div>

    <div id="pageMain" class="hidden min-h-screen pb-20">
        <header class="bg-white shadow sticky top-0 z-50">
            <div class="max-w-4xl mx-auto flex justify-between items-center p-4">
                <div>
                    <div class="font-bold text-lg text-blue-900 leading-tight" id="dSekolah">Loading...</div>
                    <div class="text-xs text-gray-500 mt-1">Guru: <span id="dGuru" class="font-bold text-black"></span></div>
                </div>
                <button onclick="logout()" class="text-xs bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded hover:bg-red-100 font-bold">LOGOUT</button>
            </div>
            <div class="max-w-4xl mx-auto flex border-t bg-white">
                <div onclick="switchTab('input')" id="tab1" class="tab-btn active"><i class="fas fa-edit mr-2"></i> INPUT JURNAL</div>
                <div onclick="switchTab('history')" id="tab2" class="tab-btn"><i class="fas fa-history mr-2"></i> RIWAYAT</div>
            </div>
        </header>

        <div class="max-w-4xl mx-auto mt-6 px-4">
            
            <div id="viewInput">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-5 border-b pb-3">
                        <h3 class="font-bold text-lg text-gray-800" id="formTitle">Input Kegiatan Baru</h3>
                        <button onclick="resetForm()" id="btnCancel" class="hidden text-red-500 text-xs font-bold uppercase hover:underline">Batal Edit</button>
                    </div>

                    <form id="formJurnal" onsubmit="submitData(event)" class="space-y-4">
                        <input type="hidden" name="id" id="inputId">
                        
                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">TANGGAL KEGIATAN</label><input type="date" name="tanggal" required class="w-full border p-2 rounded bg-blue-50"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">JAM LAYANAN</label><input type="text" name="jam" placeholder="1-2" class="w-full border p-2 rounded"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">DURASI</label><input type="text" name="waktu" placeholder="40 Menit" class="w-full border p-2 rounded"></div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">SASARAN</label><input type="text" name="sasaran" placeholder="Siswa / Guru / Ortu" required class="w-full border p-2 rounded"></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">KELAS / STATUS</label><input type="text" name="kelas" placeholder="Cth: IX A" class="w-full border p-2 rounded"></div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">BIDANG</label><select name="bidang" class="w-full border p-2 rounded bg-white"><option>Pribadi</option><option>Sosial</option><option>Belajar</option><option>Karir</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">JENIS LAYANAN</label><input type="text" name="jenis" list="ls" class="w-full border p-2 rounded" placeholder="Pilih/Ketik..."><datalist id="ls"><option value="Konseling Individu"><option value="Bimbingan Kelompok"><option value="Bimbingan Klasikal"><option value="Konsultasi"></datalist></div>
                        </div>

                        <div><label class="text-xs font-bold text-gray-500 block mb-1">TOPIK / MASALAH</label><input type="text" name="topik" class="w-full border p-2 rounded"></div>

                        <div class="grid md:grid-cols-2 gap-5">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">TUJUAN</label><textarea name="tujuan" rows="2" class="w-full border p-2 rounded"></textarea></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">MEDIA / ALAT</label><input type="text" name="media" class="w-full border p-2 rounded"></div>
                        </div>

                        <div><label class="text-xs font-bold text-gray-500 block mb-1">RINGKASAN PROSES</label><textarea name="ringkasan" rows="3" class="w-full border p-2 rounded"></textarea></div>

                        <div class="grid md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded border">
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">EVALUASI</label><textarea name="evaluasi" rows="2" class="w-full border p-2 rounded bg-white"></textarea></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">TINDAK LANJUT</label><textarea name="tindaklanjut" rows="2" class="w-full border p-2 rounded bg-white"></textarea></div>
                            <div><label class="text-xs font-bold text-gray-500 block mb-1">CATATAN KHUSUS</label><textarea name="catatan" rows="2" class="w-full border p-2 rounded bg-white"></textarea></div>
                        </div>

                        <button id="btnSimpan" class="w-full bg-blue-600 text-white font-bold py-3 rounded shadow hover:bg-blue-700 transition flex justify-center items-center gap-2"><i class="fas fa-save"></i> SIMPAN JURNAL</button>
                    </form>
                </div>
            </div>

            <div id="viewHistory" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">Data Riwayat</h3>
                    <button onclick="loadHistory()" class="text-blue-600 text-sm hover:underline"><i class="fas fa-sync"></i> Refresh</button>
                </div>
                <div id="listContainer" class="space-y-4 pb-20"></div>
            </div>

        </div>
    </div>

    <div id="printArea" class="hidden">
        <div class="kop">
            <div class="k1" id="p_pem"></div>
            <div class="k1" id="p_ins"></div>
            <div class="k2" id="p_sek"></div>
            <div class="k3" id="p_almt"></div>
        </div>

        <div class="judul-pdf" id="p_judul">LAPORAN PELAKSANAAN LAYANAN BIMBINGAN DAN KONSELING</div>
        <div class="info-ta">
            Tahun Pelajaran: <span id="p_ta"></span> | Semester: <span id="p_sem"></span>
        </div>

        <table class="tbl-pdf">
            <tr><td class="col-label">Hari, Tanggal</td><td id="t1"></td></tr>
            <tr><td class="col-label">Jam / Waktu Layanan</td><td><span id="t2"></span> / <span id="t3"></span></td></tr>
            <tr><td class="col-label">Sasaran Layanan</td><td id="t4"></td></tr>
            <tr><td class="col-label">Kelas / Status</td><td id="t5"></td></tr>
            <tr><td class="col-label">Bidang Bimbingan</td><td id="t6"></td></tr>
            <tr><td class="col-label">Jenis Layanan</td><td id="t7"></td></tr>
            <tr><td class="col-label">Topik / Masalah</td><td id="t8"></td></tr>
            <tr><td class="col-label">Tujuan Layanan</td><td id="t9"></td></tr>
            <tr><td class="col-label">Media / Alat</td><td id="t10"></td></tr>
            <tr><td class="col-label">Ringkasan Proses</td><td id="t11" style="min-height: 80px;"></td></tr>
            <tr><td class="col-label">Hasil Evaluasi</td><td id="t12"></td></tr>
            <tr><td class="col-label">Rencana Tindak Lanjut</td><td id="t13"></td></tr>
            <tr><td class="col-label">Catatan Khusus</td><td id="t14"></td></tr>
        </table>

        <div class="ttd-wrap">
            <div class="ttd-box">
                <p>Mengetahui,</p>
                <p>Kepala Sekolah</p>
                <div class="ttd-nama" id="pkep"></div>
                <p>NIP. <span id="pnipkep"></span></p>
            </div>
            <div class="ttd-box">
                <p>Makassar, <span id="ptglttd"></span></p>
                <p>Guru BK</p>
                <div class="ttd-nama" id="pguru"></div>
                <p>NIP. <span id="pnipguru"></span></p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PASTE URL WEB APP APPS SCRIPT DI SINI
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxMbp7LlrCgbwoAIB_xCtrHCTpRI9s2zKT7BhH7E-d2qOnP2O8AzO4vxjl-EsaDMTwGog/exec"; 

        let user=null, conf=null, historyData=[];

        function switchTab(t){
            document.getElementById('viewInput').classList.add('hidden');
            document.getElementById('viewHistory').classList.add('hidden');
            document.getElementById('tab1').classList.remove('active');
            document.getElementById('tab2').classList.remove('active');
            if(t=='input'){
                document.getElementById('viewInput').classList.remove('hidden');
                document.getElementById('tab1').classList.add('active');
            } else {
                document.getElementById('viewHistory').classList.remove('hidden');
                document.getElementById('tab2').classList.add('active');
                loadHistory();
            }
        }

        async function doLogin(e){
            e.preventDefault(); loading(true);
            try {
                let u=document.getElementById('u').value, p=document.getElementById('p').value;
                let r=await fetch(`${API_URL}?action=login&u=${u}&p=${p}`).then(x=>x.json());
                if(r.status=='sukses'){
                    user=r;
                    conf=await fetch(`${API_URL}?action=getConfig`).then(x=>x.json());
                    document.getElementById('pageLogin').classList.add('hidden');
                    document.getElementById('pageMain').classList.remove('hidden');
                    document.getElementById('dSekolah').innerText=conf.sekolah;
                    document.getElementById('dGuru').innerText=user.nama;
                    switchTab('input');
                } else alert(r.message);
            } catch(e){alert("Gagal Koneksi ke Server");}
            loading(false);
        }

        async function submitData(e){
            e.preventDefault();
            if(!confirm("Simpan Data?")) return;
            loading(true);
            
            let fd = new FormData(document.getElementById('formJurnal'));
            let d = Object.fromEntries(fd.entries());
            d.action="simpan"; d.namaGuru=user.nama; d.nipGuru=user.nip; 
            d.alamatGuru=user.alamat; d.ta=conf.ta; d.semester=conf.semester;

            try {
                await fetch(API_URL, {method:'POST', body:JSON.stringify(d)});
                alert("Berhasil Disimpan!");
                resetForm();
                switchTab('history');
            } catch(x){alert("Gagal Simpan");}
            loading(false);
        }

        async function loadHistory(){
            try {
                let r=await fetch(`${API_URL}?action=getHistory&nip=${user.nip}`).then(x=>x.json());
                historyData=r.data;
                let h="";
                if(historyData.length==0) h=`<div class="text-center p-8 bg-white border rounded text-gray-400">Belum ada data.</div>`;
                
                historyData.forEach((d,i)=>{
                    h+=`
                    <div class="bg-white p-4 border rounded shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between mb-2">
                            <div class="font-bold text-blue-900">${d.topik}</div>
                            <div class="text-xs text-gray-500">${d.tanggal.substring(0,10)}</div>
                        </div>
                        <div class="text-sm text-gray-700 mb-3">${d.sasaran} (${d.kelas}) - <b>${d.jenis}</b></div>
                        <div class="flex gap-2 border-t pt-3">
                            <button onclick="viewItem(${i})" class="flex-1 bg-gray-100 text-gray-700 py-1 rounded text-xs font-bold hover:bg-gray-200"><i class="fas fa-eye"></i> LIHAT</button>
                            <button onclick="editItem(${i})" class="flex-1 bg-yellow-50 text-yellow-600 py-1 rounded text-xs font-bold hover:bg-yellow-100"><i class="fas fa-edit"></i> EDIT</button>
                            <button onclick="printItem(${i})" class="flex-1 bg-green-50 text-green-600 py-1 rounded text-xs font-bold hover:bg-green-100"><i class="fas fa-print"></i> PDF</button>
                            <button onclick="deleteItem('${d.id}')" class="flex-1 bg-red-50 text-red-600 py-1 rounded text-xs font-bold hover:bg-red-100"><i class="fas fa-trash"></i> HAPUS</button>
                        </div>
                    </div>`;
                });
                document.getElementById('listContainer').innerHTML=h;
            } catch(e){}
        }

        function viewItem(i){
            let d=historyData[i];
            let html=`
                <table class="w-full text-sm">
                    <tr><td class="font-bold py-1 w-1/3">Tanggal</td><td>: ${d.tanggal.substring(0,10)}</td></tr>
                    <tr><td class="font-bold py-1">Waktu</td><td>: ${d.jam} (${d.waktu})</td></tr>
                    <tr><td class="font-bold py-1">Sasaran</td><td>: ${d.sasaran} (${d.kelas})</td></tr>
                    <tr><td class="font-bold py-1">Layanan</td><td>: ${d.jenis} (${d.bidang})</td></tr>
                    <tr><td colspan="2"><hr class="my-2"></td></tr>
                    <tr><td class="font-bold py-1" colspan="2">Topik/Masalah:</td></tr>
                    <tr><td colspan="2" class="pl-2 mb-2 block bg-gray-50 p-2 rounded">${d.topik}</td></tr>
                    <tr><td class="font-bold py-1" colspan="2">Tujuan & Ringkasan:</td></tr>
                    <tr><td colspan="2" class="pl-2 mb-2 block bg-gray-50 p-2 rounded">${d.tujuan}<br><br>${d.ringkasan}</td></tr>
                    <tr><td class="font-bold py-1" colspan="2">Evaluasi & Tindak Lanjut:</td></tr>
                    <tr><td colspan="2" class="pl-2 block bg-gray-50 p-2 rounded">${d.evaluasi}<br><br>${d.tindaklanjut}</td></tr>
                </table>`;
            document.getElementById('modalContent').innerHTML=html;
            document.getElementById('modalView').classList.remove('hidden');
        }
        function closeModal(){document.getElementById('modalView').classList.add('hidden');}

        function editItem(i){
            let d=historyData[i];
            switchTab('input');
            document.getElementById('inputId').value=d.id;
            let f=document.getElementById('formJurnal');
            f.tanggal.value=d.tanggal.substring(0,10); f.jam.value=d.jam; f.waktu.value=d.waktu;
            f.sasaran.value=d.sasaran; f.kelas.value=d.kelas; f.bidang.value=d.bidang; f.jenis.value=d.jenis;
            f.topik.value=d.topik; f.tujuan.value=d.tujuan; f.media.value=d.media;
            f.ringkasan.value=d.ringkasan; f.evaluasi.value=d.evaluasi;
            f.tindaklanjut.value=d.tindaklanjut; f.catatan.value=d.catatan;
            
            document.getElementById('formTitle').innerText="Edit Jurnal";
            document.getElementById('btnSimpan').innerHTML="<i class='fas fa-sync'></i> UPDATE DATA";
            document.getElementById('btnSimpan').classList.replace('bg-blue-600','bg-orange-500');
            document.getElementById('btnCancel').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function resetForm(){
            document.getElementById('formJurnal').reset();
            document.getElementById('inputId').value="";
            document.getElementById('formTitle').innerText="Input Kegiatan Baru";
            document.getElementById('btnSimpan').innerHTML="<i class='fas fa-save'></i> SIMPAN JURNAL";
            document.getElementById('btnSimpan').classList.replace('bg-orange-500','bg-blue-600');
            document.getElementById('btnCancel').classList.add('hidden');
        }

        async function deleteItem(id){
            if(!confirm("Yakin hapus permanen?")) return;
            loading(true);
            try {
                await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'hapus',id:id})});
                alert("Terhapus"); loadHistory();
            } catch(e){alert("Gagal Hapus");}
            loading(false);
        }

        // --- FUNGSI CETAK PDF (FIXED) ---
        function printItem(i){
            let d=historyData[i];
            
            // 1. Mapping Header
            document.getElementById('p_pem').innerText=conf.pem;
            document.getElementById('p_ins').innerText=conf.instansi;
            document.getElementById('p_sek').innerText=conf.sekolah;
            document.getElementById('p_almt').innerText=conf.alamat;
            document.getElementById('p_judul').innerText=conf.judul || "LAPORAN LAYANAN";
            
            // 2. Mapping Data TA & Sem (YANG BARU)
            document.getElementById('p_ta').innerText=conf.ta;
            document.getElementById('p_sem').innerText=conf.semester;

            // 3. Mapping Isi Tabel
            document.getElementById('t1').innerText=d.tanggal.substring(0,10);
            document.getElementById('t2').innerText=d.jam; document.getElementById('t3').innerText=d.waktu;
            document.getElementById('t4').innerText=d.sasaran; document.getElementById('t5').innerText=d.kelas;
            document.getElementById('t6').innerText=d.bidang; document.getElementById('t7').innerText=d.jenis;
            document.getElementById('t8').innerText=d.topik; document.getElementById('t9').innerText=d.tujuan;
            document.getElementById('t10').innerText=d.media; document.getElementById('t11').innerText=d.ringkasan;
            document.getElementById('t12').innerText=d.evaluasi; document.getElementById('t13').innerText=d.tindaklanjut;
            document.getElementById('t14').innerText=d.catatan;

            // 4. Mapping TTD
            document.getElementById('pkep').innerText=conf.kepsek; document.getElementById('pnipkep').innerText=conf.nip_kepsek;
            document.getElementById('pguru').innerText=user.nama; document.getElementById('pnipguru').innerText=user.nip;
            document.getElementById('ptglttd').innerText=d.tanggal.substring(0,10);

            // 5. Eksekusi Print
            window.print();
        }

        function logout(){location.reload();}
        function loading(x){document.getElementById('loading').classList.toggle('hidden',!x);}
    </script>
</body>
</html>
